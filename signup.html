<!DOCTYPE html>
<html>
<head>
    <title>Women Safety Signup</title>

    <!-- FaceAPI & Tesseract -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>

    <style>
        body {
            background:#0a1a2f;
            font-family: Arial;
            color:white;
            display:flex;
            justify-content:center;
            align-items:center;
            height:100vh;
        }
        .box{
            width:360px;
            padding:25px;
            background:#112233;
            border-radius:12px;
            box-shadow:0 0 15px #0005;
        }
        input{
            width:100%;
            padding:12px;
            margin:10px 0;
            background:#1e2d40;
            border:none;
            border-radius:8px;
            color:white;
        }
        button{
            width:100%;
            padding:12px;
            background:#3fa2ff;
            border:none;
            border-radius:8px;
            color:black;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
            margin-top:10px;
        }
    </style>
</head>

<body>
<div class="box">
    <h2 style="text-align:center;color:#3fa2ff">Create Account</h2>

    <input type="text" id="name" placeholder="Full Name">

    <label>Upload Government ID (Front):</label>
    <input type="file" id="idImage" accept="image/*">

    <label>Upload Selfie:</label>
    <input type="file" id="selfieImage" accept="image/*">

    <input type="password" id="password" placeholder="Password">

    <button onclick="verifyUser()">Verify & Signup</button>
</div>

<script>

async function verifyUser() {
    let name = document.getElementById("name").value;
    let idImage = document.getElementById("idImage").files[0];
    let selfieImage = document.getElementById("selfieImage").files[0];
    let pass = document.getElementById("password").value;

    if (!idImage || !selfieImage) {
        alert("Please upload both ID and selfie");
        return;
    }

    // 1️⃣ OCR Check on ID (Female or Male)
    const idData = await Tesseract.recognize(idImage, 'eng');
    let text = idData.data.text.toUpperCase();

    if (text.includes("MALE") === true) {
        alert("Verification Failed: This app is for women only.");
        return;
    }
    if (!text.includes("FEMALE")) {
        alert("Cannot detect gender from ID. Try clearer image.");
        return;
    }

    // 2️⃣ Face Compare (Selfie vs ID)
    await faceapi.nets.ssdMobilenetv1.loadFromUri("https://justadummyurl.com"); 
    await faceapi.nets.faceRecognitionNet.loadFromUri("https://justadummyurl.com");
    await faceapi.nets.faceLandmark68Net.loadFromUri("https://justadummyurl.com");

    let idImg = await faceapi.bufferToImage(idImage);
    let selfieImg = await faceapi.bufferToImage(selfieImage);

    let idFace = await faceapi.detectSingleFace(idImg).withFaceLandmarks().withFaceDescriptor();
    let selfieFace = await faceapi.detectSingleFace(selfieImg).withFaceLandmarks().withFaceDescriptor();

    if (!idFace || !selfieFace) {
        alert("Face not detected properly. Try proper lighting.");
        return;
    }

    const distance = faceapi.euclideanDistance(idFace.descriptor, selfieFace.descriptor);

    if (distance > 0.55) {
        alert("Face does not match ID photo. Verification failed.");
        return;
    }

    // 3️⃣ If everything passes → Save & Signup
    let user = {
        name: name,
        pass: pass,
        verified: true
    };

    localStorage.setItem("user", JSON.stringify(user));
    alert("Signup Successful! You are verified.");
    window.location.href = "map.html";
}
</script>

</body>
</html>
